------------------------------------------------------------------------------------------------------------------------------------
-- –ü—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ –º–æ–¥—É–ª—é 16

-- –ù–∞–ø–∏—à–∏—Ç–µ –ø–∞–∫–µ—Ç pkg_agg_employees.
-- –í –ø–∞–∫–µ—Ç–µ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—É—Ä—Å–æ—Ä —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –æ—Ç–¥–µ–ª–æ–≤ –∏ —Ä–∞–±–æ—Ç. 
-- –ü–æ —ç—Ç–æ–º—É –∫—É—Ä—Å–æ—Ä—É —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–æ–ª–ª–µ–∫—Ü–∏—è, —Å–æ—Å—Ç–æ—è—â–∞—è –∏–∑ —Å—É–º–º—ã –∑–∞—Ä–ø–ª–∞—Ç, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç–µ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç–µ –≤ —Ä–∞–∑—Ä–µ–∑–µ –æ—Ç–¥–µ–ª–æ–≤.

-- –ï—â–µ –æ–¥–Ω–æ –ø–æ–ª–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–º–µ–Ω–∞ –∏ —Ñ–∞–º–∏–ª–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Ä–∞–∑—Ä–µ–∑–µ –æ—Ç–¥–µ–ª–æ–≤. 
-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –∫—É—Ä—Å–æ—Ä–µ —Ñ—É–Ω–∫—Ü–∏—é listagg() —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º - –ø–µ—Ä–µ–≤–æ–¥–æ–º –∫–∞—Ä–µ—Ç–∫–∏ (chr(10)).

-- –°–æ–±—Ä–∞–Ω–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º —ç—Ç–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã. 
-- –ü–æ–¥—Å–∫–∞–∑–∫–∞: –¥–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –Ω—É–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Ç—É–¥–∞ —Ç–∏–ø —Ç–∞–±–ª–∏—Ü—ã –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–∞.

-- –í —Ä–∞–º–∫–∞—Ö —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω–≤–µ–π–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –∏–∑ –∑–∞–¥–∞–Ω–∏—è 2 –∏ –ø–æ –∫–æ–Ω–≤–µ–π–µ—Ä—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç—Ç–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å—É.

-- –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
create or replace package pkg_agg_employees
is          
    type agg_type is record (sum_salary NUMBER,
                             min_salary NUMBER,  
                             max_salary NUMBER,  
                             employees VARCHAR2(1024));

    type agg_tbl is table of agg_type; 

    procedure agg_proc (v_agg_tbl out agg_tbl); 
    
    function agg_func return agg_tbl pipelined;

end pkg_agg_employees;

-- –¢–µ–ª–æ –ø–∞–∫–µ—Ç–∞
create or replace package body pkg_agg_employees
is

    procedure agg_proc (v_agg_tbl out agg_tbl) 
    as
        cursor c_report
        is         
        select sum(salary) as sum_sal,
               min(salary) as min_sal,
               max(salary) as max_sal,
--             listagg (first_name || ' ' || last_name || ', ' || chr(10)) WITHIN GROUP (ORDER BY dep.department_name) "employees"
               listagg (first_name || ' ' || last_name || ', ' || chr(10)) WITHIN GROUP (ORDER BY dep.department_name) AS employees
        from employees emp
        join departments dep on dep.department_id = emp.department_id
        join jobs j on j.job_id = emp.job_id
        group by dep.department_name
        ;
       begin
        open c_report;
            loop
                exit when c_report%notfound;
                fetch c_report bulk collect into v_agg_tbl limit 10000;
            end loop;
        close c_report;
    end agg_proc; 

    function agg_func return agg_tbl pipelined as
       v_var pkg_agg_employees.agg_tbl;
    begin   
       agg_proc(v_var);
       for i in v_var.first..v_var.last loop
           pipe row (v_var(i));
       end loop;
       return;   
    end agg_func; 

end pkg_agg_employees; 


-- –ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –≤—ã–∑–æ–≤–∞ –∫–æ–Ω–≤–µ–π–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

select * from table(pkg_agg_employees.agg_func);


------------------------------------------------------------------------------------------------------------------------------------
-- –ü—Ä–∞–∫—Ç–∏–∫–∞ —É—Ä–æ–∫–∞ 16.

------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 1 –?–∑ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω –∏ –∏–∑ –Ω–µ–≥–æ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å—Ç—Ä–æ–∫—É —Å —Ç—Ä–µ—Ç—å–µ–≥–æ —Å–∏–º–≤–æ–ª–∞ —Å –¥–ª–∏–Ω–æ–π 5 —Å–∏–º–≤–æ–ª–æ–≤.

select substr (country_name, 3, 5) as col1
from countries;


------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 2 –ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞–Ω–∏—è 1 –≤ CLOB –∏ —Å–¥–µ–ª–∞–π—Ç–µ –≤—Ç–æ—Ä–æ–µ –ø–æ–ª–µ —Å —Ç–∏–ø–æ–º –¥–∞–Ω–Ω—ã—Ö CLOB —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–∏. 
-- –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤ –≤–µ—Ä—Ö–Ω–µ–º –∑–∞–ø—Ä–æ—Å–µ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ —Å–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –ø–æ–ª–µ–π.

select dbms_lob.compare (col1, col2) as compprator,
       col1,
       col2
from (select substr (to_clob(country_name), 3, 5) as col1,
             substr (to_clob(lead(country_name) over (order by country_id)),3,5) as col2
from countries);

------------------------------------------------------------------------------------------------------------------------------------
--  –ó–∞–¥–∞–Ω–∏–µ 3 –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É prc_print_department_list, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ –≤—Ö–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–≤—É—Ö—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ CLOB –¥–∞–Ω–Ω—ã–µ –ø–æ –æ—Ç–¥–µ–ª–∞–º, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω.


create or replace PROCEDURE prc_print_department_list (p_country_id varchar2)
as
    v_result clob;
    
    cursor c_departments
    is
        select distinct
           dep.department_name
        from departments dep 
        join locations loc on loc.location_id = dep.location_id
        join countries c on c.country_id = loc.country_id
        where  c.country_id like '%'||p_country_id||'%';

begin 
    v_result := empty_clob();
    
    dbms_lob.createtemporary (v_result, true);
        
        for r in c_departments loop
            dbms_lob.append (v_result, r.department_name || chr(10));
        end loop;
    
    dbms_lob.freetemporary (v_result);
    
    dbms_output.put_line (v_result);
    
exception
   when others then
      dbms_lob.freetemporary (v_result);
      dbms_output.put_line (sqlerrm);

end prc_print_department_list;

exec prc_print_department_list('US');

select c.country_id,
       c.country_name,
       l.location_id,
       d.location_id,
       d.department_name
from countries c
join locations l on l.country_id = c.country_id
join departments d on d.location_id = l.location_id
where c.country_id = 'US';

select distinct
       d.department_name
from departments d 
join locations l on l.location_id = d.location_id
join countries c on c.country_id = l.country_id
where c.country_id = 'US';

------------------------------------------------------------------------------------------------------------------------------------
-- –ü—Ä–∞–∫—Ç–∏–∫–∞ —É—Ä–æ–∫–∞ 16.2

------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 1 –ù–∞–ø–∏—à–∏—Ç–µ –ø–∞–∫–µ—Ç pkg_get_employees, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–Ω–≤–µ–π–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é. –£ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞ –∫–æ–¥ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞, 
-- –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏–∑ —Ç–∞–±–ª–∏—Ü —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –æ—Ç–¥–µ–ª–æ–≤. 

-- –ö–æ–Ω–≤–µ–π–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π: 
-- –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –∏–º—è, —Ñ–∞–º–∏–ª–∏—è, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞, –≥–æ—Ä–æ–¥.

create or replace package pkg_get_employees
is
    
    type get_emp_rec is record (id              number,
                                first_name      varchar2(20),                
                                last_name       varchar2(25),   
                                email           varchar2(25),                                   
                                phone           varchar2(20),  
                                salary          number,
                                department_name varchar2(30), 
                                city            varchar2(30));
                                
    type get_emp_tbl is table of get_emp_rec;
    
    function get_emp (p_department_id number) return get_emp_tbl pipelined;
    
end pkg_get_employees;

drop package pkg_get_employees;

create or replace package body pkg_get_employees
is
    function get_emp (p_department_id number) return get_emp_tbl pipelined
    is 
        v_get_emp_row get_emp_rec;
        
        cursor c_get_emp 
        is
        select e.EMPLOYEE_ID,
               e.FIRST_NAME,
               e.LAST_NAME,
               e.EMAIL,
               e.PHONE_NUMBER,
               e.SALARY,
               d.department_name,
               l.city
        from employees e 
        join DEPARTMENTS d on e.DEPARTMENT_ID = d.DEPARTMENT_ID
        join LOCATIONS l on d.LOCATION_ID = l.LOCATION_ID
        where e.DEPARTMENT_ID = p_department_id
        order by l.city, 
                 e.last_name,
                 e.first_name;
begin 
    for r in c_get_emp loop
        v_get_emp_row := null;
        
        v_get_emp_row.ID := r.EMPLOYEE_ID;
        v_get_emp_row.FIRST_NAME := r.FIRST_NAME;
        v_get_emp_row.LAST_NAME := r.LAST_NAME;
        v_get_emp_row.EMAIL := r.EMAIL;
        v_get_emp_row.PHONE := r.PHONE_NUMBER;
        v_get_emp_row.SALARY := r.SALARY;
        v_get_emp_row.department_name := r.department_name;
        v_get_emp_row.city := r.city;       
        
        pipe row (v_get_emp_row);
    end loop;
    return;
end get_emp;    

end pkg_get_employees;


select e.EMPLOYEE_ID,
       e.FIRST_NAME,
       e.LAST_NAME,
       e.EMAIL,
       e.PHONE_NUMBER,
       e.SALARY,
       d.department_name,
       l.city
from employees e 
join DEPARTMENTS d on e.DEPARTMENT_ID = d.DEPARTMENT_ID
join LOCATIONS l on d.LOCATION_ID = l.LOCATION_ID
--where e.DEPARTMENT_ID = p_depepartment_id
order by l.city, 
         e.last_name,
         e.first_name

------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 2 –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ –¥–∞–Ω–Ω—ã–º –∏–∑ –∫–æ–Ω–≤–µ–π–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

select * from table(pkg_get_employees.get_emp(100))
where last_name like 'C%';

------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 3 –ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å, –æ—Å–Ω–æ–≤—ã–≤–∞—é—â–∏–π—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–≤–µ–π–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –∞–≥—Ä–µ–≥–∞—Ç –ø–æ —Å—É–º–º–µ –∑–∞—Ä–ø–ª–∞—Ç, 
-- –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å—Ä–µ–¥–Ω–µ–π –∑–∞—Ä–ø–ª–∞—Ç–µ –≤ —Ä–∞–∑—Ä–µ–∑–µ –≥–æ—Ä–æ–¥–æ–≤.

select sum(salary),
       count(id),
       city
from table(pkg_get_employees.get_emp(100))
group by city;



------------------------------------------------------------------------------------------------------------------------------------
-- –ü—Ä–∞–∫—Ç–∏–∫–∞ —É—Ä–æ–∫–∞ 16.1

------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 1 –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É prc_print_employee_card, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ –≤—Ö–æ–¥ –±—É–¥–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Ç–∏–ø–∞ date. 
-- –í –ø—Ä–æ—Ü–µ–¥—É—Ä–µ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –∫—É—Ä—Å–æ—Ä –ø–æ —Ç–∞–±–ª–∏—Ü–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å—Ç—Ä–∞–Ω, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —ç—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç. 
-- –° –ø–æ–º–æ—â—å—é –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä–∫—É –ø–æ –ø–æ–ª—é –¥–∞—Ç—ã –ø—Ä–∏–µ–º–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É, —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é. 
-- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω—É–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é –ø–æ–ª–µ–π: –?–º—è, –§–∞–º–∏–ª–∏—è, –ì–æ—Ä–æ–¥, –ó–∞—Ä–ø–ª–∞—Ç–∞.


create or replace PROCEDURE prc_print_employee_card (p_empdate date)
as
type employee_type is record (first_name varchar2(32),
                              last_name varchar2(32),
                              job_title varchar2(32),
                              salary number);
type employee_tbl is table of employee_type;

v_employee_tbl employee_tbl;

cursor c_emp 
is
select e.first_name, 
       e.last_name, 
       j.job_title, 
       e.salary
from employees e
     join jobs j on e.job_id = j.job_id
where e.hire_date like '%'||p_empdate||'%';

begin
open c_emp;
loop
    exit when c_emp%notfound;
    fetch c_emp bulk collect into v_employee_tbl limit 3;
    
    for i in 1..v_employee_tbl.count
    loop
        dbms_output.put_line(v_employee_tbl(i).first_name);  
    end loop;
end loop;

end;



------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 2 –ù–∞–ø–∏—à–∏—Ç–µ –±–ª–æ–∫ –≤—ã–∑–æ–≤–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏–∑ –∑–∞–¥–∞–Ω–∏—è 1 –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å —Ä–∞–∑–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏.

exec prc_print_employee_card(10.10.2005);

exec prc_print_employee_card(10.10.2005);

exec prc_print_employee_card(10.10.2005);

------------------------------------------------------------------------------------------------------------------------------------
-- –ó–∞–¥–∞–Ω–∏–µ 3 –ü–µ—Ä–µ–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É prc_print_employee_card —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —É—Å–ª–æ–≤–∏–π —Ü–∏–∫–ª–æ–≤ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ –ª–µ–∫—Ü–∏–∏.


